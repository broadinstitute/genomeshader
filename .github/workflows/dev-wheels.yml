name: Dev Wheels

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: read
  packages: write  # for GitHub Packages

jobs:
  build-dev-wheel:
    name: build-dev-wheel
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Read base version
        id: version
        run: |
          VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "base_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Base version: $VERSION"

      - name: Sanitize branch name for PEP 440 (pyproject.toml)
        id: branch_pep440
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          # PEP 440 local version: alphanumeric, dots, hyphens, underscores allowed
          # Replace / with . for PEP 440
          SANITIZED=$(echo "$BRANCH_NAME" | sed 's/\//./g' | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "branch_name=$SANITIZED" >> $GITHUB_OUTPUT
          echo "Branch name (PEP 440): $BRANCH_NAME -> $SANITIZED"

      - name: Sanitize branch name for SemVer (Cargo.toml)
        id: branch_semver
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          # SemVer pre-release: only alphanumeric and hyphens allowed (no dots, no underscores)
          # Replace / and . with - for SemVer
          SANITIZED=$(echo "$BRANCH_NAME" | sed 's/[\/.]/-/g' | sed 's/[^a-zA-Z0-9-]/-/g')
          echo "branch_name=$SANITIZED" >> $GITHUB_OUTPUT
          echo "Branch name (SemVer): $BRANCH_NAME -> $SANITIZED"

      - name: Create dev versions
        id: dev_versions
        run: |
          BASE_VERSION="${{ steps.version.outputs.base_version }}"
          # PEP 440 format for pyproject.toml: 0.1.89+dev.kvg-gh-yml
          PYTHON_VERSION="${BASE_VERSION}+dev.${{ steps.branch_pep440.outputs.branch_name }}"
          # SemVer pre-release format for Cargo.toml: 0.1.89-dev-kvg-gh-yml
          CARGO_VERSION="${BASE_VERSION}-dev-${{ steps.branch_semver.outputs.branch_name }}"
          echo "python_version=$PYTHON_VERSION" >> $GITHUB_OUTPUT
          echo "cargo_version=$CARGO_VERSION" >> $GITHUB_OUTPUT
          echo "Python version (PEP 440): $PYTHON_VERSION"
          echo "Cargo version (SemVer): $CARGO_VERSION"

      - name: Update version files for build
        run: |
          PYTHON_VERSION="${{ steps.dev_versions.outputs.python_version }}"
          CARGO_VERSION="${{ steps.dev_versions.outputs.cargo_version }}"
          # Update pyproject.toml with PEP 440 format
          sed -i.bak "s/version = \".*\"/version = \"$PYTHON_VERSION\"/" pyproject.toml
          # Update Cargo.toml with SemVer pre-release format
          sed -i.bak "s/^version = \".*\"/version = \"$CARGO_VERSION\"/" Cargo.toml
          # Show changes
          echo "Updated versions:"
          grep "version" pyproject.toml
          grep "^version" Cargo.toml

      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist
          manylinux: auto
          sccache: "true"

      - name: Restore version files
        if: always()
        run: |
          # Restore original files
          mv pyproject.toml.bak pyproject.toml 2>/dev/null || true
          mv Cargo.toml.bak Cargo.toml 2>/dev/null || true

      - uses: actions/upload-artifact@v4
        with:
          name: dev-wheel
          path: dist/*.whl

  publish-dev-wheel:
    name: publish-dev-wheel
    runs-on: ubuntu-latest
    needs: [build-dev-wheel]
    if: always() && needs.build-dev-wheel.result != 'failure'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dev-wheel
          path: dist

      - name: Publish to GitHub Packages
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          repository-url: https://pypi.packages.github.com/broadinstitute/genomeshader
          username: __token__
          password: ${{ secrets.GITHUB_TOKEN }}

