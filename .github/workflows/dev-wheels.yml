name: Dev Wheels

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: read
  packages: write  # for GitHub Packages

jobs:
  build-dev-wheel:
    name: build-dev-wheel
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Read base version
        id: version
        run: |
          VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "base_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Base version: $VERSION"

      - name: Sanitize branch name
        id: branch
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          # Create a short hash of the branch name for use in version
          # This ensures it's always valid and short
          BRANCH_HASH=$(echo -n "$BRANCH_NAME" | sha256sum | cut -c1-8)
          # Also create a sanitized version for readability (alphanumeric and hyphens only)
          SANITIZED=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-20)
          echo "branch_hash=$BRANCH_HASH" >> $GITHUB_OUTPUT
          echo "branch_sanitized=$SANITIZED" >> $GITHUB_OUTPUT
          echo "Branch name: $BRANCH_NAME"
          echo "Branch hash: $BRANCH_HASH"
          echo "Branch sanitized: $SANITIZED"

      - name: Create dev version
        id: dev_version
        run: |
          BASE_VERSION="${{ steps.version.outputs.base_version }}"
          # Use PEP 440 dev version format: 0.1.89.dev0+branch-hash
          # This format is compatible with both PEP 440 and can be converted by maturin
          # Using .dev0 (numeric) + local version identifier (branch hash)
          DEV_VERSION="${BASE_VERSION}.dev0+${{ steps.branch.outputs.branch_hash }}"
          echo "dev_version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "Dev version: $DEV_VERSION"

      - name: Update pyproject.toml for build
        run: |
          DEV_VERSION="${{ steps.dev_version.outputs.dev_version }}"
          # Only update pyproject.toml - maturin will sync to Cargo.toml automatically
          sed -i.bak "s/version = \".*\"/version = \"$DEV_VERSION\"/" pyproject.toml
          # Show changes
          echo "Updated pyproject.toml version:"
          grep "version" pyproject.toml

      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist
          manylinux: auto
          sccache: "true"

      - name: Restore version file
        if: always()
        run: |
          # Restore original pyproject.toml
          mv pyproject.toml.bak pyproject.toml 2>/dev/null || true

      - uses: actions/upload-artifact@v4
        with:
          name: dev-wheel
          path: dist/*.whl

  publish-dev-wheel:
    name: publish-dev-wheel
    runs-on: ubuntu-latest
    needs: [build-dev-wheel]
    if: always() && needs.build-dev-wheel.result != 'failure'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dev-wheel
          path: dist

      - name: Publish to GitHub Packages
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          repository-url: https://pypi.packages.github.com/broadinstitute/genomeshader
          username: __token__
          password: ${{ secrets.GITHUB_TOKEN }}

