name: Dev Wheels

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: write  # needed to create releases and upload assets

jobs:
  build-dev-wheel:
    name: build-dev-wheel
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Read base version
        id: version
        run: |
          VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "base_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Base version: $VERSION"

      - name: Sanitize branch name
        id: branch
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          # Create a short hash of the branch name for use in version
          # This ensures it's always valid and short
          BRANCH_HASH=$(echo -n "$BRANCH_NAME" | sha256sum | cut -c1-8)
          # Also create a sanitized version for readability (alphanumeric and hyphens only)
          SANITIZED=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-20)
          echo "branch_hash=$BRANCH_HASH" >> $GITHUB_OUTPUT
          echo "branch_sanitized=$SANITIZED" >> $GITHUB_OUTPUT
          echo "Branch name: $BRANCH_NAME"
          echo "Branch hash: $BRANCH_HASH"
          echo "Branch sanitized: $SANITIZED"

      - name: Create dev version
        id: dev_version
        run: |
          BASE_VERSION="${{ steps.version.outputs.base_version }}"
          # Use PEP 440 dev version format: 0.1.89.dev0+branch-hash
          # This format is compatible with both PEP 440 and can be converted by maturin
          # Using .dev0 (numeric) + local version identifier (branch hash)
          DEV_VERSION="${BASE_VERSION}.dev0+${{ steps.branch.outputs.branch_hash }}"
          echo "dev_version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "Dev version: $DEV_VERSION"

      - name: Update pyproject.toml for build
        run: |
          DEV_VERSION="${{ steps.dev_version.outputs.dev_version }}"
          # Only update pyproject.toml - maturin will sync to Cargo.toml automatically
          sed -i.bak "s/version = \".*\"/version = \"$DEV_VERSION\"/" pyproject.toml
          # Show changes
          echo "Updated pyproject.toml version:"
          grep "version" pyproject.toml

      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist
          manylinux: auto
          sccache: "true"
          before-script-linux: |
            # If we're running on rhel centos, install needed packages.
            if command -v yum &> /dev/null; then
              yum update -y && yum install -y perl-core openssl openssl-devel pkgconfig libatomic

              # If we're running on i686 we need to symlink libatomic
              # in order to build openssl with -latomic flag.
              if [[ ! -d "/usr/lib64" ]]; then
                ln -s /usr/lib/libatomic.so.1 /usr/lib/libatomic.so
              fi
            else
            # If we're running on debian-based system.
              apt update -y && apt-get install -y libssl-dev openssl pkg-config perl
            fi

      - name: Restore version file
        if: always()
        run: |
          # Restore original pyproject.toml
          mv pyproject.toml.bak pyproject.toml 2>/dev/null || true

      - name: Get wheel filename
        id: wheel
        run: |
          WHEEL_FILE=$(ls dist/*.whl | head -n 1 | xargs basename)
          echo "filename=$WHEEL_FILE" >> $GITHUB_OUTPUT
          echo "Wheel filename: $WHEEL_FILE"

      - name: Create or update GitHub Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dev-${{ steps.branch.outputs.branch_sanitized }}-${{ steps.branch.outputs.branch_hash }}
          name: Dev Build - ${{ github.ref_name }} (${{ steps.dev_version.outputs.dev_version }})
          body: |
            Development wheel for branch `${{ github.ref_name }}`
            
            **Version:** `${{ steps.dev_version.outputs.dev_version }}`
            **Commit:** ${{ github.sha }}
            **Branch:** `${{ github.ref_name }}`
            
            ## Installation
            
            **Option 1: Download and install manually**
            1. Download the `.whl` file from the assets below
            2. Install with: `pip install genomeshader-*.whl`
            
            **Option 2: Install via script (bash)**
            ```bash
            TAG="dev-${{ steps.branch.outputs.branch_sanitized }}-${{ steps.branch.outputs.branch_hash }}"
            FILENAME="${{ steps.wheel.outputs.filename }}"
            URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${FILENAME}"
            
            wget -O "${FILENAME}" "${URL}"
            pip install "${FILENAME}"
            ```
            
            **Option 3: In Jupyter/Colab (recommended)**
            ```python
            tag = "dev-${{ steps.branch.outputs.branch_sanitized }}-${{ steps.branch.outputs.branch_hash }}"
            filename = "${{ steps.wheel.outputs.filename }}"
            url = f"https://github.com/${{ github.repository }}/releases/download/{tag}/{filename}"
            
            # Download with the actual wheel filename (pip needs this to parse metadata)
            !wget -O {filename} {url}
            !pip install {filename}
            ```
          draft: false
          prerelease: true
          files: dist/*.whl
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wheel build summary
        if: success()
        run: |
          echo "## âœ… Dev Wheel Built and Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.dev_version.outputs.dev_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [View Release](${{ steps.release.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Install" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download and install:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**In Jupyter/Colab:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`python" >> $GITHUB_STEP_SUMMARY
          echo "tag = \"dev-${{ steps.branch.outputs.branch_sanitized }}-${{ steps.branch.outputs.branch_hash }}\"" >> $GITHUB_STEP_SUMMARY
          echo "filename = \"${{ steps.wheel.outputs.filename }}\"" >> $GITHUB_STEP_SUMMARY
          echo "url = f\"https://github.com/${{ github.repository }}/releases/download/{tag}/{filename}\"" >> $GITHUB_STEP_SUMMARY
          echo "!wget -O {filename} {url}" >> $GITHUB_STEP_SUMMARY
          echo "!pip install {filename}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**In bash:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "TAG=\"dev-${{ steps.branch.outputs.branch_sanitized }}-${{ steps.branch.outputs.branch_hash }}\"" >> $GITHUB_STEP_SUMMARY
          echo "FILENAME=\"${{ steps.wheel.outputs.filename }}\"" >> $GITHUB_STEP_SUMMARY
          echo "wget -O \"\${FILENAME}\" \"https://github.com/${{ github.repository }}/releases/download/\${TAG}/\${FILENAME}\"" >> $GITHUB_STEP_SUMMARY
          echo "pip install \"\${FILENAME}\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

