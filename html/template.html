<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>genomeshader</title>
    <style>
    body {
        display: grid;
        grid-template-areas: 
            "header header header"
            "main main aside"
            "footer footer aside";
        grid-template-rows: auto 1fr auto;
        grid-template-columns: 1fr auto;
        height: 100vh;
        margin: 0;
        padding: 0;
    }
    header {
        grid-area: header;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        height: 24px;
        padding: 6px 3px;
        background: #eeeeee;
    }
    .header-left {
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }
    .header-center {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .header-right {
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }
    .header-left i, .header-right i {
        padding-left: 5px;
        padding-right: 5px;
    }
    nav {
        grid-area: nav;
    }
    main {
        grid-area: main;
        height: calc(100vh - 24px - 40px);
        width: 100%;
    }
    aside {
        display: hidden;
        grid-area: aside;
        transition: width 0.3s;
        background-color: #cccccc;
        border-left: 1px solid #bbbbbb;
        max-width: 300px;
        width: 0;
        overflow: hidden;
    }
    .menu-icon {
        cursor: pointer;
    }
    .sidebar-icon-close {
        display: none;
        cursor: pointer;
    }
    .sidebar-icon-open {
        cursor: pointer;
    }
    .report-bug-icon {
        cursor: pointer;
    }
    .gear-icon {
        cursor: pointer;
    }
    footer {
        position: fixed;
        bottom: 10px;
        left: 10px;
        right: 210px;
        height: 20px;
        padding: 6px 3px;
        display: flex;
        align-items: center;
        justify-content: left;
        color: #989898;
        font-family: Helvetica;
        font-size: 10pt;
    }
    .tab-bar {
        height: 22px;
        color: #ffffff;
        font-family: Helvetica;
        font-size: 9pt;
        font-weight: bold;
        background-color: #888888;
        display: flex;
        align-items: flex-end;
    }
    .tab-name {
        color: #ffffff;
        padding: 3px 3px;
        margin: 2px 2px;
        font-family: Helvetica;
        font-size: 9pt;
        font-weight: bold;
    }
    .tab-content-viewer {
        color: #ffffff;
        padding: 4px;
        margin: 0px;
        color: #a8a8a8;
        background-color: #ffffff;
        font-family: Helvetica;
        font-size: 9pt;
        font-weight: bold;
    }
    .tab-content-info {
        color: #ffffff;
        padding: 20px 8px;
        margin: 0px;
        color: #585858;
        font-family: Helvetica;
        font-size: 9pt;
    }
    </style>
</head>

<body>

<header>
    <div class="header-left">
        <i class="menu-icon" onclick="alert('Not yet implemented.')">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="18" height="18" viewBox="0 0 24 24">
                <g transform="translate(0, 0)">
                    <path d="M4 6H20M4 12H20M4 18H20" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </g>
            </svg>
        </i>
    </div>
    <div class="header-center">
        <!-- genomeshader -->
    </div>
    <div class="header-right">
        <i class="sidebar-icon-close" onclick="closeSidebar()">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="18" height="18" viewBox="0 0 24 24">
                <g transform="translate(0, 0)">
                    <path fill-rule="evenodd" d="M7.22 14.47L9.69 12 7.22 9.53a.75.75 0 111.06-1.06l3 3a.75.75 0 010 1.06l-3 3a.75.75 0 01-1.06-1.06z"></path>
                    <path fill-rule="evenodd" d="M3.75 2A1.75 1.75 0 002 3.75v16.5c0 .966.784 1.75 1.75 1.75h16.5A1.75 1.75 0 0022 20.25V3.75A1.75 1.75 0 0020.25 2H3.75zM3.5 3.75a.25.25 0 01.25-.25H15v17H3.75a.25.25 0 01-.25-.25V3.75zm13 16.75v-17h3.75a.25.25 0 01.25.25v16.5a.25.25 0 01-.25.25H16.5z"></path>
                </g>
            </svg>
        </i>
        <i class="sidebar-icon-open" onclick="openSidebar()">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="18" height="18" viewBox="0 0 24 24">
                <g transform="translate(0, 0)">
                    <path fill-rule="evenodd" d="M11.28 9.53L8.81 12l2.47 2.47a.75.75 0 11-1.06 1.06l-3-3a.75.75 0 010-1.06l3-3a.75.75 0 111.06 1.06z"></path>
                    <path fill-rule="evenodd" d="M3.75 2A1.75 1.75 0 002 3.75v16.5c0 .966.784 1.75 1.75 1.75h16.5A1.75 1.75 0 0022 20.25V3.75A1.75 1.75 0 0020.25 2H3.75zM3.5 3.75a.25.25 0 01.25-.25H15v17H3.75a.25.25 0 01-.25-.25V3.75zm13 16.75v-17h3.75a.25.25 0 01.25.25v16.5a.25.25 0 01-.25.25H16.5z"></path>
                </g>
            </svg>
        </i>
        <a href="https://github.com/broadinstitute/genomeshader/issues" target="_blank">
            <i class="report-bug-icon">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="18" height="18" viewBox="0 0 24 24">
                    <g transform="translate(0, 0)">
                        <path fill-rule="evenodd" d="M3.25 4a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h2.5a.75.75 0 01.75.75v3.19l3.427-3.427A1.75 1.75 0 0111.164 17h9.586a.25.25 0 00.25-.25V4.25a.25.25 0 00-.25-.25H3.25zm-1.75.25c0-.966.784-1.75 1.75-1.75h17.5c.966 0 1.75.784 1.75 1.75v12.5a1.75 1.75 0 01-1.75 1.75h-9.586a.25.25 0 00-.177.073l-3.5 3.5A1.457 1.457 0 015 21.043V18.5H3.25a1.75 1.75 0 01-1.75-1.75V4.25zM12 6a.75.75 0 01.75.75v4a.75.75 0 01-1.5 0v-4A.75.75 0 0112 6zm0 9a1 1 0 100-2 1 1 0 000 2z"></path>
                    </g>
                </svg>
            </i>
        </a>
        <i class="gear-icon" onclick="alert('Not yet implemented.')">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="18" height="18" viewBox="0 0 24 24">
                <g transform="translate(0, 0)">
                    <path fill-rule="evenodd" d="M16 12a4 4 0 11-8 0 4 4 0 018 0zm-1.5 0a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path><path fill-rule="evenodd" d="M12 1c-.268 0-.534.01-.797.028-.763.055-1.345.617-1.512 1.304l-.352 1.45c-.02.078-.09.172-.225.22a8.45 8.45 0 00-.728.303c-.13.06-.246.044-.315.002l-1.274-.776c-.604-.368-1.412-.354-1.99.147-.403.348-.78.726-1.129 1.128-.5.579-.515 1.387-.147 1.99l.776 1.275c.042.069.059.185-.002.315-.112.237-.213.48-.302.728-.05.135-.143.206-.221.225l-1.45.352c-.687.167-1.249.749-1.304 1.512a11.149 11.149 0 000 1.594c.055.763.617 1.345 1.304 1.512l1.45.352c.078.02.172.09.22.225.09.248.191.491.303.729.06.129.044.245.002.314l-.776 1.274c-.368.604-.354 1.412.147 1.99.348.403.726.78 1.128 1.129.579.5 1.387.515 1.99.147l1.275-.776c.069-.042.185-.059.315.002.237.112.48.213.728.302.135.05.206.143.225.221l.352 1.45c.167.687.749 1.249 1.512 1.303a11.125 11.125 0 001.594 0c.763-.054 1.345-.616 1.512-1.303l.352-1.45c.02-.078.09-.172.225-.22.248-.09.491-.191.729-.303.129-.06.245-.044.314-.002l1.274.776c.604.368 1.412.354 1.99-.147.403-.348.78-.726 1.129-1.128.5-.579.515-1.387.147-1.99l-.776-1.275c-.042-.069-.059-.185.002-.315.112-.237.213-.48.302-.728.05-.135.143-.206.221-.225l1.45-.352c.687-.167 1.249-.749 1.303-1.512a11.125 11.125 0 000-1.594c-.054-.763-.616-1.345-1.303-1.512l-1.45-.352c-.078-.02-.172-.09-.22-.225a8.469 8.469 0 00-.303-.728c-.06-.13-.044-.246-.002-.315l.776-1.274c.368-.604.354-1.412-.147-1.99-.348-.403-.726-.78-1.128-1.129-.579-.5-1.387-.515-1.99-.147l-1.275.776c-.069.042-.185.059-.315-.002a8.465 8.465 0 00-.728-.302c-.135-.05-.206-.143-.225-.221l-.352-1.45c-.167-.687-.749-1.249-1.512-1.304A11.149 11.149 0 0012 1zm-.69 1.525a9.648 9.648 0 011.38 0c.055.004.135.05.162.16l.351 1.45c.153.628.626 1.08 1.173 1.278.205.074.405.157.6.249a1.832 1.832 0 001.733-.074l1.275-.776c.097-.06.186-.036.228 0 .348.302.674.628.976.976.036.042.06.13 0 .228l-.776 1.274a1.832 1.832 0 00-.074 1.734c.092.195.175.395.248.6.198.547.652 1.02 1.278 1.172l1.45.353c.111.026.157.106.161.161a9.653 9.653 0 010 1.38c-.004.055-.05.135-.16.162l-1.45.351a1.833 1.833 0 00-1.278 1.173 6.926 6.926 0 01-.25.6 1.832 1.832 0 00.075 1.733l.776 1.275c.06.097.036.186 0 .228a9.555 9.555 0 01-.976.976c-.042.036-.13.06-.228 0l-1.275-.776a1.832 1.832 0 00-1.733-.074 6.926 6.926 0 01-.6.248 1.833 1.833 0 00-1.172 1.278l-.353 1.45c-.026.111-.106.157-.161.161a9.653 9.653 0 01-1.38 0c-.055-.004-.135-.05-.162-.16l-.351-1.45a1.833 1.833 0 00-1.173-1.278 6.928 6.928 0 01-.6-.25 1.832 1.832 0 00-1.734.075l-1.274.776c-.097.06-.186.036-.228 0a9.56 9.56 0 01-.976-.976c-.036-.042-.06-.13 0-.228l.776-1.275a1.832 1.832 0 00.074-1.733 6.948 6.948 0 01-.249-.6 1.833 1.833 0 00-1.277-1.172l-1.45-.353c-.111-.026-.157-.106-.161-.161a9.648 9.648 0 010-1.38c.004-.055.05-.135.16-.162l1.45-.351a1.833 1.833 0 001.278-1.173 6.95 6.95 0 01.249-.6 1.832 1.832 0 00-.074-1.734l-.776-1.274c-.06-.097-.036-.186 0-.228.302-.348.628-.674.976-.976.042-.036.13-.06.228 0l1.274.776a1.832 1.832 0 001.734.074 6.95 6.95 0 01.6-.249 1.833 1.833 0 001.172-1.277l.353-1.45c.026-.111.106-.157.161-.161z"></path>
                </g>
            </svg>
        </i>
    </div>
</header>

<main>
<div class="tab-bar">
    <span class="tab-name">
        <i class="tab-viewer-icon">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="12" height="12" viewBox="0 -3 24 24">
                <g transform="translate(0, 0)">
                    <path fill="#ffffff" stroke="#ffffff" fill-rule="evenodd" d="M19.25 4.5H4.75a.25.25 0 00-.25.25v14.5c0 .138.112.25.25.25h.19l9.823-9.823a1.75 1.75 0 012.475 0l2.262 2.262V4.75a.25.25 0 00-.25-.25zm.25 9.56l-3.323-3.323a.25.25 0 00-.354 0L7.061 19.5H19.25a.25.25 0 00.25-.25v-5.19zM4.75 3A1.75 1.75 0 003 4.75v14.5c0 .966.784 1.75 1.75 1.75h14.5A1.75 1.75 0 0021 19.25V4.75A1.75 1.75 0 0019.25 3H4.75zM8.5 9.5a1 1 0 100-2 1 1 0 000 2zm0 1.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path>
                </g>
            </svg>
        </i>
        Viewer
    </span>
</div>

<footer>Status</footer>

</main>

<aside>
<div class="tab-bar">
    <span class="tab-name">
        <i class="tab-info-icon">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="12" height="12" viewBox="0 -3 24 24">
                <g transform="translate(0, 0)">
                    <path fill="#ffffff" stroke="#ffffff" fill-rule="evenodd" d="M0 4.75C0 3.784.784 3 1.75 3h20.5c.966 0 1.75.784 1.75 1.75v14.5A1.75 1.75 0 0122.25 21H1.75A1.75 1.75 0 010 19.25V4.75zm1.75-.25a.25.25 0 00-.25.25v14.5c0 .138.112.25.25.25h20.5a.25.25 0 00.25-.25V4.75a.25.25 0 00-.25-.25H1.75z"></path>
                    <path fill="#ffffff" stroke="#ffffff" fill-rule="evenodd" d="M5 8.75A.75.75 0 015.75 8h11.5a.75.75 0 010 1.5H5.75A.75.75 0 015 8.75zm0 4a.75.75 0 01.75-.75h5.5a.75.75 0 010 1.5h-5.5a.75.75 0 01-.75-.75z"></path>
                </g>
            </svg>
        </i>
        Information
    </span>
</div>
<div class="tab-content-info">
Hello
</div>
</aside>

<script>
function closeSidebar() {
    document.querySelector('.sidebar-icon-close').style.display = 'none';
    document.querySelector('.sidebar-icon-open').style.display = 'block';
    document.querySelector('aside').style.width = '0';
}

function openSidebar() {
    document.querySelector('.sidebar-icon-open').style.display = 'none';
    document.querySelector('.sidebar-icon-close').style.display = 'block';
    document.querySelector('aside').style.width = '300px';
}
</script>

<script type="module">
    // Load data
    window.data = JSON.parse("{\"ideogram\": {\"columns\": [{\"name\": \"chrom\", \"datatype\": \"String\", \"bit_settings\": \"\", \"values\": [\"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\", \"chr15\"]}, {\"name\": \"chromStart\", \"datatype\": \"Int64\", \"bit_settings\": \"\", \"values\": [0, 4200000, 9700000, 17500000, 19000000, 20500000, 25500000, 27800000, 30000000, 30900000, 33400000, 39800000, 42500000, 43300000, 44500000, 49200000, 52600000, 58800000, 59000000, 63400000, 66900000, 67000000, 67200000, 72400000, 74900000, 76300000, 78000000, 81400000, 84700000, 88500000, 93800000, 98000000]}, {\"name\": \"chromEnd\", \"datatype\": \"Int64\", \"bit_settings\": \"\", \"values\": [4200000, 9700000, 17500000, 19000000, 20500000, 25500000, 27800000, 30000000, 30900000, 33400000, 39800000, 42500000, 43300000, 44500000, 49200000, 52600000, 58800000, 59000000, 63400000, 66900000, 67000000, 67200000, 72400000, 74900000, 76300000, 78000000, 81400000, 84700000, 88500000, 93800000, 98000000, 101991189]}, {\"name\": \"name\", \"datatype\": \"String\", \"bit_settings\": \"\", \"values\": [\"p13\", \"p12\", \"p11.2\", \"p11.1\", \"q11.1\", \"q11.2\", \"q12\", \"q13.1\", \"q13.2\", \"q13.3\", \"q14\", \"q15.1\", \"q15.2\", \"q15.3\", \"q21.1\", \"q21.2\", \"q21.3\", \"q22.1\", \"q22.2\", \"q22.31\", \"q22.32\", \"q22.33\", \"q23\", \"q24.1\", \"q24.2\", \"q24.3\", \"q25.1\", \"q25.2\", \"q25.3\", \"q26.1\", \"q26.2\", \"q26.3\"]}, {\"name\": \"gieStain\", \"datatype\": \"String\", \"bit_settings\": \"\", \"values\": [\"gvar\", \"stalk\", \"gvar\", \"acen\", \"acen\", \"gneg\", \"gpos50\", \"gneg\", \"gpos50\", \"gneg\", \"gpos75\", \"gneg\", \"gpos25\", \"gneg\", \"gpos75\", \"gneg\", \"gpos75\", \"gneg\", \"gpos25\", \"gneg\", \"gpos25\", \"gneg\", \"gpos25\", \"gneg\", \"gpos25\", \"gneg\", \"gpos50\", \"gneg\", \"gpos50\", \"gneg\", \"gpos50\", \"gneg\"]}, {\"name\": \"color\", \"datatype\": \"String\", \"bit_settings\": \"\", \"values\": [\"#660099\", \"#6600cc\", \"#660099\", \"#660033\", \"#660033\", \"#ffffff\", \"#808080\", \"#ffffff\", \"#808080\", \"#ffffff\", \"#404040\", \"#ffffff\", \"#c0c0c0\", \"#ffffff\", \"#404040\", \"#ffffff\", \"#404040\", \"#ffffff\", \"#c0c0c0\", \"#ffffff\", \"#c0c0c0\", \"#ffffff\", \"#c0c0c0\", \"#ffffff\", \"#c0c0c0\", \"#ffffff\", \"#808080\", \"#ffffff\", \"#808080\", \"#ffffff\", \"#808080\", \"#ffffff\"]}]}, \"ref_chr\": \"chr15\", \"ref_start\": \"23960193\", \"ref_end\": \"23963918\"}");
</script>

<script type="module">
import { Application, Graphics, Text, TextStyle, Color } from 'https://cdn.skypack.dev/pixi.js@8.1.0';

// Some initial settings.
window.zoom = 0;

// Create a PixiJS application.
const app = new Application();

// Function to initialize and render the PixiJS application.
async function renderApp() {
    // Get main HTMLElement.
    var main = document.querySelector('main');

    // Intialize the application.
    await app.init({
        antialias: false,
        resolution: window.devicePixelRatio || 1,
        autoDensity: true,
        backgroundColor: '#ffffff',
        resizeTo: main,
    });

    // Then adding the application's canvas to the DOM body.
    main.appendChild(app.canvas);

    // Listen for window resize events.
    window.addEventListener('resize', repaint);

    repaint();
}

document.addEventListener('wheel', function(e) {
    const multiplier = e.shiftKey ? 10.0 : 1.0;

    const locus_start = parseInt(window.data.ref_start) + window.zoom + (multiplier*e.deltaY);
    const locus_end = parseInt(window.data.ref_end) - window.zoom - (multiplier*e.deltaY);

    if (locus_end - locus_start >= 1) {
        window.zoom += e.deltaY;
    }

    repaint();
});

// Resize function window
function repaint() {
    var main = document.querySelector('main');

	// Resize the renderer
	app.renderer.resize(main.offsetWidth, main.offsetHeight);

    // Clear the application stage
    app.stage.removeChildren();

    // Draw all the elements
    drawIdeogram(main, window.data.ideogram, window.data.ref_start, window.data.ref_end, window.zoom);
    drawRuler(main, window.data.ref_start, window.data.ref_end, window.zoom);
    // await drawTranscripts(main);
}

// Function to draw the ideogram.
async function drawIdeogram(main, ideogramData, ref_start, ref_end, zoom) {
    const graphics = new Graphics();

    const ideoLength = ideogramData.columns[2].values[ideogramData.columns[2].values.length - 1];
    const ideoWidth = 18;
    const ideoHeight = main.offsetHeight - 150;
    const ideoX = 15;
    const ideoY = 40;

    graphics.interactive = true;
    graphics.buttonMode = true;

    const tooltip = new Text({
        text: '',
        style: {
            fontFamily: 'Helvetica',
            fontSize: 9,
            fill: 0x777777,
            align: 'center'
        }
    });

    tooltip.visible = false;
    app.stage.addChild(tooltip);

    graphics.on('mousemove', (event) => {
        if (tooltip.visible) {
            tooltip.position.set(event.data.global.x + 10, event.data.global.y + 10);
        }
    });

    graphics.on('mouseout', () => {
        tooltip.visible = false;
    });

    let bandY = ideoY;
    let acenSeen = false;
    for (let i = ideogramData.columns[0].values.length - 1; i >= 0; i--) {
        let bandHeight = (ideogramData.columns[2].values[i] - ideogramData.columns[1].values[i]) * ideoHeight / ideoLength;
        let bandStart = ideogramData.columns[1].values[i];
        let bandEnd = ideogramData.columns[2].values[i];
        let bandName = ideogramData.columns[3].values[i];
        let bandStain = ideogramData.columns[4].values[i];
        let bandColor = ideogramData.columns[5].values[i];

        const band = new Graphics();

        band.interactive = true;
        band.buttonMode = true;

        band.on('mouseover', () => {
            tooltip.text = bandStart + "-" + bandEnd;
            tooltip.visible = true;
        });

        band.on('mouseout', () => {
            tooltip.visible = false;
        });

        if (bandStain == 'acen') {
            const blank = new Graphics();
            blank.rect(ideoX, bandY, ideoWidth, bandHeight);
            blank.stroke({ width: 2, color: 0xffffff });
            blank.fill("#ffffff");
            graphics.addChild(blank);

            if (!acenSeen) {
                band.moveTo(ideoX, bandY);
                band.lineTo(ideoX + ideoWidth - 0.5, bandY);
                band.lineTo(ideoX + (ideoWidth / 2), bandY + bandHeight);
                band.lineTo(ideoX, bandY);
            } else {
                band.moveTo(ideoX, bandY + bandHeight);
                band.lineTo(ideoX + ideoWidth - 0.5, bandY + bandHeight);
                band.lineTo(ideoX + (ideoWidth / 2), bandY);
                band.lineTo(ideoX, bandY + bandHeight);
            }

            band.stroke({ width: 1, color: 0x333333 });
            band.fill(bandColor);
            acenSeen = true;
        } else {
            band.rect(ideoX, bandY, ideoWidth, bandHeight);
            band.stroke({ width: 0, color: 0x333333 });
            band.fill(bandColor);

            function invertColor(hex) {
                // If the color is in hex format (e.g., #FFFFFF), remove the hash
                if (hex.indexOf('#') === 0) {
                    hex = hex.slice(1);
                }

                // If the color is in shorthand hex format (e.g., #FFF), convert to full format
                if (hex.length === 3) {
                    hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
                }

                // Convert the hex color to its RGB components
                var r = parseInt(hex.slice(0, 2), 16),
                    g = parseInt(hex.slice(2, 4), 16),
                    b = parseInt(hex.slice(4, 6), 16);

                // Invert each component by subtracting it from 255
                r = (255 - r).toString(16);
                g = (255 - g).toString(16);
                b = (255 - b).toString(16);

                // Ensure each inverted component has two digits
                r = r.length === 1 ? '0' + r : r;
                g = g.length === 1 ? '0' + g : g;
                b = b.length === 1 ? '0' + b : b;

                // Return the inverted color in hex format
                return '#' + r + g + b;
            }

            const bandLabel = new Text({
                text: bandName,
                style: {
                    fontFamily: 'Helvetica',
                    fontSize: 7,
                    fill: invertColor(bandColor),
                    align: 'center'
                }
            });

            bandLabel.rotation = -Math.PI / 2;
            bandLabel.x = ideoX + bandLabel.height / 2;
            bandLabel.y = bandY + bandHeight / 2 + bandLabel.width / 2;

            if (bandLabel.width <= 0.9*bandHeight) {
                band.addChild(bandLabel);
            }
        }

        graphics.addChild(band);
        bandY += bandHeight;
    }

    graphics.rect(ideoX, ideoY, ideoWidth, ideoHeight);
    graphics.stroke({ width: 2, color: 0x333333 });
    graphics.fill(0xffffff);

    app.stage.addChild(graphics);

    const chrText = new Text({
        text: ideogramData.columns[0].values[0],
        style: {
            fontFamily: 'Helvetica',
            fontSize: 12,
            fill: 0x000000,
            align: 'center',
        }
    });

    chrText.x = 17;
    chrText.y = main.offsetHeight - 70;
    chrText.rotation = - Math.PI / 2;

    app.stage.addChild(chrText);

    const locus_start = parseInt(ref_start) + zoom;
    const locus_end = parseInt(ref_end) - zoom;
    const pixels_per_base = ideoHeight / ideoLength;
    const selection_start = 50 + ((ideoLength - locus_end) * pixels_per_base);
    const selection_height = (locus_end - locus_start)*pixels_per_base;

    const selection = new Graphics();
    selection.rect(ideoX - 5, selection_start, ideoWidth + 10, selection_height < 5 ? 5 : selection_height);
    selection.fill("#aa000033");
    graphics.addChild(selection);
}

async function drawRuler(main, ref_start, ref_end, zoom) {
    const locus_start = parseInt(ref_start) + zoom;
    const locus_end = parseInt(ref_end) - zoom;

    const graphics = new Graphics();

    // Draw tics at various points
    const range = locus_end - locus_start;
    const locus_spacing = Math.floor(range / 11);
    const tic_spacing = Math.floor(((main.offsetHeight - 55) - 15) / 10);
    let axis_height = -tic_spacing;
    for (let i = locus_end, j = 20; i >= locus_start; i -= locus_spacing, j += tic_spacing) {
        graphics.setStrokeStyle(1.0, 0x555555);
        graphics.moveTo(102, j);
        graphics.lineTo(108, j);
        graphics.endFill();

        const locusText = new Text({
            text: i.toLocaleString(),
            style: {
                fontFamily: 'Helvetica',
                fontSize: 9,
                fill: 0x000000,
                align: 'center',
            },
            x: 55,
            y: j - 5,
        });

        axis_height += tic_spacing;

        app.stage.addChild(locusText);
    }

    // Axis line
    graphics.setStrokeStyle(1.0, 0x555555);
    graphics.moveTo(105, 20);
    graphics.lineTo(105, axis_height - 52);
    graphics.endFill();

    app.stage.addChild(graphics);

    // Display range
    const locusTextRange = new Text({
        text: "(" + (locus_end - locus_start).toLocaleString() + " bp)",
        style: {
            fontFamily: 'Helvetica',
            fontSize: 9,
            fill: 0x000000,
            align: 'center',

        },
        x: 108,
        y: 15 + ((main.offsetHeight - 55 - 15)/2),
    });
    locusTextRange.rotation = - Math.PI / 2;

    app.stage.addChild(locusTextRange);
}

async function drawTranscripts(main) {
    const graphics = new Graphics();

    graphics.setStrokeStyle(1.5, 0x5555ff);
    graphics.moveTo(130, 30);
    graphics.lineTo(130, main.offsetHeight - 300);
    graphics.endFill();

    app.stage.addChild(graphics);
}

// Call the function initially
renderApp();
</script>

</body>

</html>
